// ==UserScript==
// @name              拒绝打开傻逼百度题库+单词翻译
// @namespace         http://tampermonkey.net/
// @version           0.1
// @author            chai21sks
// @description       在浏览器右上角显示一个文本框，双击英文单词时调用有道翻译API并显示翻译结果【学习自用】
// @match             *://*/*
// @match             *://*.easylearn.baidu.com/*
// @grant             GM_xmlhttpRequest
// @grant             GM_addStyle
// ==/UserScript==

let Fanyi_Flag = true;
let selectedText = null;
let popupWindow = null;

// 关闭所有弹窗
function closeAllPopups() {
    if (popupWindow) {
        popupWindow.close();
    }
}

(function() {
    'use strict';

    // 判断当前网址是否匹配模式
    const currentUrl = window.location.href;
    const pattern1 = /^https?:\/\/([^.]+\.)?easylearn\.baidu\.com\/.*$/;
    const pattern2 = /^https?:\/\/([^.]+\.)?www.baidu.com\/.*$/;
    if (pattern1.test(currentUrl)) {
        // 关闭页面
        window.close();
    } else if (pattern2.test(currentUrl) == false) {
        // 获取选中的文本
        function getSelectedText() {
            if (window.getSelection) {
                return window.getSelection().toString();
            } else if (document.selection && document.selection.type !== "Control") {
                return document.selection.createRange().text;
            }
            return "";
        }

        // 替换文本并打开链接
        function replaceTextAndOpenLink(text) {
            if (text.trim() !== "") {
                // 构建链接
                var link = "https://dict.youdao.com/w/eng/" + encodeURIComponent(text);

                // 打开链接在新窗口中
                popupWindow = window.open(link, "_blank", "width=800,height=600");
            }
        }

        // 监听双击事件
        document.addEventListener("dblclick", function() {
            closeAllPopups();
            var selectedText = getSelectedText();
            replaceTextAndOpenLink(selectedText);
        });

    }
})();
